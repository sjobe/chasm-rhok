<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" media="screen" href="css/index.css" />
<link rel="stylesheet" type="text/css" href="css/jsxgraph.css" />
<script type="text/javascript" src="lib/jsxgraphcore.js"></script>
<script type="text/javascript" src="lib/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="lib/index.js"></script>
<script type="text/javascript" src="lib/translate.js"></script>
<script type="text/javascript" src="lib/chasmArrayUtils.js"></script>
<script type="text/javascript" src="lib/soilGrade.js"></script>
<script type="text/javascript" src="lib/raintable.js"></script>
<title>rhok - CHASM Web UI</title>
</head>
<body>
  <div id="page">
    <div id="logo"></div>
    <div id="main-col">
      <div id="tabs">
        <a href="#" class="selected first" id="info">Info</a>
        <a href="#" id="profile">Profile</a>
        <a href="#" id="soil">Soil</a>
        <a href="#" id="water">Water</a>
        <a href="#" id="rain" class="last">Rain</a>
        <div class="clear"></div>
      </div>
      <div id="tab-pages">
        <form action="chasm.php" method="post">
          <div class="tab-page selected info">
            <p>Enter the slope name and location</p>
            <table>
              <tr>
                <th>Name</th>
                <td><input name="info_name" id="info_name" type="text"/></td>
              </tr>
              <tr>
                <th>Latitude<br><span style="font-weight:normal; font-size:0.8em;">in decimal degrees</span></th>
                <td><input onkeypress="validate(event)" name="info_latitude" id="info_latitude" type="text"/></td>
              </tr>
              <tr>
                <th>Longitude<br><span style="font-weight:normal; font-size:0.8em;">in decimal degrees</span></th>
                <td><input onkeypress="validate(event)" name="info_long" id="info_long" type="text"/></td>
              </tr>
              <tr>
                <td colspan="2" class="callout">(assume WGS84 coordinate system)</td>
              </tr>
            </table>
          </div>
          <div class="tab-page profile">
            <p class="table-title">Enter profile segments</p>
            <div class="table-title">
              <a href="#" class="button add-profile-segment">Add New Segment</a>
              <span># segments: <span class="num-profile-segments"></span></span>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Height (m)</th>
                  <th>Length (m)</th>
                  <th>Angle (degrees)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="profile-data">
              </tbody>
            </table>
          </div>
          <div class="tab-page soil">
            <p>Enter the solid strata:</p>
            <table class="soil-table">
              <tr>
                <th></th><th>Strata 1</th><th>Strata 2</th><th>Strata 3</th><th>Strata 4</th>
              </tr>
              <tr>
                <td class="table-title" colspan="5">Soil Type</td>
              </tr>
              <tr>
                <td></td>
                <td>
                <select name="soil_type_strata1">
                    <option value="" selected="selected"></option>
                    <option value="1">I</option>
                    <option value="2" >II</option>
                    <option value="3" >III</option>
                    <option value="4" >IV</option>
                    <option value="5" >V</option>
                    <option value="6" >VI</option>
                  </select>
                </td>
                <td>
                  <select name="soil_type_strata2">
                    <option value="" selected="selected"></option>
                    <option value="1" >I</option>
                    <option value="2" >II</option>
                    <option value="3" >III</option>
                    <option value="4" >IV</option>
                    <option value="5" >V</option>
                    <option value="6" >VI</option>
                  </select>
                </td>
                <td>
                  <select name="soil_type_strata3">
                    <option value="" selected="selected"></option>
                    <option value="1" >I</option>
                    <option value="2" >II</option>
                    <option value="3" >III</option>
                    <option value="4" >IV</option>
                    <option value="5" >V</option>
                    <option value="6" >VI</option>
                  </select>
                </td>
                <td>
                  <select name="soil_type_strata4">
                    <option value="" selected="selected"></option>
                    <option value="1" >I</option>
                    <option value="2" >II</option>
                    <option value="3" >III</option>
                    <option value="4" >IV</option>
                    <option value="5" >V</option>
                    <option value="6" >VI</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th>C</th><td><input onkeypress="validate(event)" name="soil_strata1_c" id="soil_strata1_c"/></td><td><input onkeypress="validate(event)" name="soil_strata2_c" id="soil_strata2_c"/></td><td><input onkeypress="validate(event)" name="soil_strata3_c" id="soil_strata3_c"/></td><td><input onkeypress="validate(event)" name="soil_strata4_c" id="soil_strata4_c"/></td>
              </tr>
              <tr>
                <th>phi</th><td><input onkeypress="validate(event)" name="soil_strata1_phi" id="soil_strata1_phi"/></td><td><input onkeypress="validate(event)" name="soil_strata2_phi" id="soil_strata2_phi"/></td><td><input onkeypress="validate(event)" name="soil_strata3_phi" id="soil_strata3_phi"/></td><td><input onkeypress="validate(event)" name="soil_strata4_phi" id="soil_strata4_phi"/></td>
              </tr>
              <tr>
                <th>Ks</th><td><input onkeypress="validate(event, 'sci')" name="soil_strata1_ks" id="soil_strata1_ks"/></td><td><input onkeypress="validate(event, 'sci')" name="soil_strata2_ks" id="soil_strata2_ks"/></td><td><input onkeypress="validate(event, 'sci')" name="soil_strata3_ks" id="soil_strata3_ks"/></td><td><input onkeypress="validate(event, 'sci')" name="soil_strata4_ks" id="soil_strata4_ks"/></td>
              </tr>
              <tbody id="soil-tbody">
              <tr id="soil-depths">
                <td class="table-title"  colspan="5">Soil Depths (m)</td>
              </tr>


              </tbody>
            </table>
            <a href="#" style="padding:5px 10px;" class="button" onclick="renderSoil()">Render Soil</a>

          </div>
          <div class="tab-page water">
            <p class="table-title">Enter the water table depths:</p>
            <table>
            </table>
            <p class="table-title">Enter Upslope Recharge:</p>
            <div onkeypress="validate(event)" class="table-title upslope-recharge"><input name="water_upslope_recharge" id="water_upslope_recharge"/></div>
          </div>
          <div class="tab-page rain">
            <p class="table-title">Chose a rainfall event:</p>
            <a style="padding:5px 10px; margin:10px 0px;" href="#" class="add-rainfall button">Add New Rainfall</a>
            <table style="margin-top:10px;">
              <tr><th>Frequency (yrs)</th><th>Duration (hrs)</th><th>Volume</th><th></th></tr>
            </table>

            <!-- <div>or</div>
            <a href="#" class="define-rainfall button">Define a Rainfall</a>
             -->
          </div>

      </div>
      <!--
      <div id="prev-next">
        <a id="prev" href="javascript:func()">Prev</a>
        <a id="next" href="javascript:func()">Next</a>
      </div>
      -->
    </div>
    <div id = "graph-col">
      <div id="graph" style="height:460px;">
      	<div id="box" class="jxgbox" style="position:relative;width:460px; height:460px;">
        <div style="position:absolute; left:-15px; top: 220px; -webkit-transform: rotate(-90deg); -moz-transform: rotate(-90deg); -o-transform: rotate(-90deg);filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);font-size:0.8em; font-weight:bold;">Meters</div>
		<div style="position:absolute; left: 200px; bottom: 0px;font-size:0.8em; font-weight:bold;">Meters</div>
		<img src="img/legend.png" style="width:75px; position:absolute; top: 10px; right: 10px;"/>
        </div>
<script type="text/javascript">
      var graph = JXG.JSXGraph.initBoard('box', {boundingbox: [-5,100,150,-5], showNavigation: 0, snapToGrid: true, snapSizeX: 2, snapSizeY: 2, originX: 0, originY: 500, unitX: 150, unitY: 100, axis:true});

	  var geometryLines = new Array();
	  var geometryPoints = new Array();
	  var soilOffsets = new Array();
	  var soilPoints = new Array();
	  var soilLines = new Array(4);
	  soilLines[0] = new Array();
	  soilLines[1] = new Array();
	  soilLines[2] = new Array();
	  soilLines[3] = new Array();
	  var waterTableOffsets = new Array();
	  var waterTableLines = new Array();
	  var waterTablePoints = new Array();
	  var geometryColor = '#000000', soilColor = new Array('#DCBE84',  '#C7A675',  '#AA3961',  '#997B62'), waterColor = '#B9E2FA';


		function plotArrayOfPoints(pointsArray, dashed, lineColor){
			//clear elements from array
			var storageArray = new Array();

			//how large is storageArray? if its too small, make it large enough to hold all of the points
			if(storageArray.length < pointsArray.length){
				storageArray = new Array(pointsArray.length);
			}
			// for every set of points in the array, create a point on the graph.
			for(var x = 0; x < pointsArray.length - 1; x++){
				storageArray[x] = createLine(pointsArray[x][0],pointsArray[x][1], pointsArray[x+1][0],pointsArray[x+1][1], dashed, lineColor)
			}
			updateBoundingBox();
			return storageArray;
		}



		function setSoilOffsets(inArray){
			if(soilOffsets.length != inArray.length){
				soilOffsets = new Array(inArray.length);
			}
			soilOffsets = inArray;
		}

		function setWaterTableOffsets(inArray){
			if(waterTableOffsets.length != inArray.length){
				waterTableOffsets = new Array(inArray.length);
			}
			waterTableOffsets = inArray;
		}

		function setGeometry(inArray){
			if(geometryPoints.length != inArray.length){
				geometryPoints = new Array(inArray.length);
			}
			for(var x = 0; x < inArray.length; x++){
				geometryPoints[x] = new Array(inArray[x][0], inArray[x][1]);
			}
		}

		function updateGraph(){
			if(validateGeometry()){
				clearArrayOfElements(geometryLines);
				geometryLines = plotArrayOfPoints(geometryPoints, false, geometryColor);
			}
			if(validateSoilData()){
				convertSoilOffsetToPoints();

				for(var x = 0; x < soilPoints.length; x++){
					clearArrayOfElements(soilLines[x]);
					soilLines[x] = plotArrayOfPoints(soilPoints[x],false, soilColor[x])
				}
			}
			if(validateWaterTableData()){
				convertWaterTableOffsetToPoints();
				clearArrayOfElements(waterTableLines);
				waterTableLines = plotArrayOfPoints(waterTablePoints,  false, waterColor)
			}
		}

		function validateWaterTableData(){
			//no negatives
			if(waterTableOffsets && waterTableOffsets.length > 0){
				for(var pNum = 0; pNum < waterTableOffsets[0].length; pNum++){

				//check to make sure offset is less than geometry and >= 0
					if(waterTableOffsets[pNum] > geometryPoints[pNum][1] || waterTableOffsets[pNum] < 0){
						alert("Point number " + pNum +  " in the water table is too high or is negative.");
						return false;
					}
				}
				return true;
			} else {
				return false;
			}


		}

		function validateSoilData(){
			//expected data format:
			//    p1     p2   ...
			// 0  offset offset
			// 1
			// ...
			// soilOffsets[depth][offset1, offset2, offset3 ...]
		  //check dimensions - should be the same as the number of points in geometry
		  //check values - should be increasing for each x, 
		  //the offset can't be greater than the geometry for that point (ie, no negative points)
			if(soilOffsets && soilOffsets.length > 0){
				if(soilOffsets[0].length == geometryPoints.length){
					for(var depth = 0; depth < soilOffsets.length; depth++){
						for(var pNum = 0; pNum < soilOffsets[0].length; pNum++){
						//check for increasing
							if(depth >= 1 && soilOffsets[depth][pNum] < soilOffsets[depth][pNum-1]){
								alert("Point number " + pNum + " at depth " + depth + " is higher than the one that came before it.");
								return false;
							}
						//check to make sure offset is less than geometry and >= 0
							if(soilOffsets[depth][pNum] > geometryPoints[pNum][1] || soilOffsets[depth][pNum] < 0){
								alert("Point number " + pNum + " at depth " + depth + " in the soil data is greater than the geometry. Please make it lower.");
								return false;
							}
						}
						return true;

					}
				  } else {
					alert("There are  " + soilOffsets[0].length + " data values for the soil table but " + geometryPoints.length + " values for the geometry.");
					return false;
				  }
			} else {
				return false;
			}

		}

		function convertSoilOffsetToPoints(){
		//soil data comes in as offsets in terms of each point in the geometry. So, to calculate each value, we need to iterate through the geometry.
			//resize soil points array
			var depth = soilOffsets.length;
			var numPPoints = soilOffsets[0].length;
			soilPoints = new Array(depth);
			for(var currentDepth = 0; currentDepth < depth; currentDepth++){
				soilPoints[currentDepth] = new Array(numPPoints);
				for(var pNum = 0; pNum < numPPoints; pNum++){
					var currentGeometryXCoord = geometryPoints[pNum][0], currentGeometryYCoord = geometryPoints[pNum][1];
					soilPoints[currentDepth][pNum] = new Array(currentGeometryXCoord, currentGeometryYCoord - soilOffsets[currentDepth][pNum]);
				}
			}

		}

		function convertWaterTableOffsetToPoints(array){

			var numPPoints = waterTableOffsets.length;
			waterTablePoints = new Array(numPPoints);
			waterTablePoints = new Array(numPPoints);
			for(var pNum = 0; pNum < numPPoints; pNum++){
				var currentGeometryXCoord = geometryPoints[pNum][0], currentGeometryYCoord = geometryPoints[pNum][1];
				waterTablePoints[pNum] = new Array(currentGeometryXCoord, currentGeometryYCoord - waterTableOffsets[pNum]);
			}


		}

		function validateGeometry(){
		//can't have slopes above 90 degrees.
			for(var p = 1; p < geometryPoints.length; p++){
				var slope = (geometryPoints[p][1] - geometryPoints[p-1][1] )/(geometryPoints[p][0] - geometryPoints[p-1][0]);
				if(geometryPoints[p][0] - geometryPoints[p-1][0] == 0 && geometryPoints[p][1] - geometryPoints[p-1][1] != 0){
					//slope is undefined - vertical line
					return true;
				} else if(slope  > 0){
					alert("Point number " + p + " has caused a slope greater than 0 degrees.");
					return false;
				}
				if(geometryPoints[p][0] < geometryPoints[p-1][0]){
					alert("Point number " + p + " has a smaller X value than the one before it.");
					return false;
				}
			}
			return true;
		}

		function clearArrayOfElements(array){
			if(array){
				for(var x = 0; x < array.length; x++){
					graph.removeObject(array[x]);
				}
			}
		}

		function updateBoundingBox(){
			var lastPointNumber = geometryPoints.length;
			var leftGraphBuffer = geometryPoints[lastPointNumber-1][0]/20*-1;
			var bottomGraphBuffer = geometryPoints[0][1]/20*-1;
			graph.setBoundingBox(new Array(leftGraphBuffer, geometryPoints[0][1], geometryPoints[lastPointNumber-1][0], bottomGraphBuffer), false);

		}
		function clearElement(element){
			graph.removeObject(element);
		}

		function createPoint( xCoord, yCoord){
			return graph.createElement('point', [xCoord,yCoord]);
		}

		function createLine( xCoord1, yCoord1, xCoord2, yCoord2, dashed, lineColor){
			if(dashed == true){
				return graph.createElement('line',[[xCoord1,yCoord1],[xCoord2,yCoord2]], {straightFirst:false, straightLast:false, strokeWidth:3, strokeColor: lineColor, dash:2});
			} else {
				return graph.createElement('line',[[xCoord1,yCoord1],[xCoord2,yCoord2]], {straightFirst:false, straightLast:false, strokeWidth:3, strokeColor: lineColor});
			}
	}
</script>


      </div>
      <!--<div id="compute-button-holder"><input href="done.html" id="compute-button" class="button" type="submit" value="Create"></div>-->
      <div id="compute-button-holder"><a href="done.html" id="compute-button" class="button">Create</a></div>
    </div>
    <div class="clear"></div>
  </div>
  </form>
</body>
</html>